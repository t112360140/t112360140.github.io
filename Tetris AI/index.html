<!DOCTYPE html>
<html>
    <head>
        <title>Tetris</title>
        <script src="tfjs/tf.min.js"></script>
        <script src="tfjs/tf-backend-webgpu.js"></script>
    
        <script src="Tetris.js"></script>
        <script src="index.js"></script>
    </head>
    <body>
        <script>
            var isRun=false;
            
            var Tetris_list=[];
            tf.setBackend('cpu');
        </script>
        <button onclick="tf.setBackend('webgpu');">WebGPU</button>
        <button onclick="tf.setBackend('cpu');">CPU</button>
        <table border=1>
            <tr>
                <td>
                    <script>
                        var trainModel=null;
                        var trainConfig={};
                    </script>
                    模型訓練
                    <button onclick='
                        async function trainRun(){
                            let time=new Date().getTime();
                            console.log("Start Time: "+Date().toString());
                            await TrainModel(trainModel,trainConfig);
                            const costTimeS=Math.round(((new Date().getTime())-time)/(1000));
                            console.log("Finish Time: "+Date().toString()+"\nSpend:"+Math.round(costTimeS/3600)+"hr "+Math.round((costTimeS/60)%60)+"min "+Math.round((costTimeS)%60)+"s");
                        }
                        if(!isRun){
                            isRun=true;
                            trainRun();
                            isRun=false;
                        }
                    '>Train</button>
                    <button onclick="
                        stopTrain=true;
                    ">Stop</button>
                    <button onclick="saveModel=true;">Save Model</button><br>
                    Model:<input type="file" id="train-model" multiple="multiple"/>
                    <button onclick="
                        async function loadModel(){
                            let model=document.getElementById('train-model').files;
                            let JSON;
                            let Weights;
                            for(let i=0;i<model.length;i++){
                                if(model[i].name.includes('json')){
                                    JSON=model[i];
                                }else if(model[i].name.includes('bin')){
                                    Weights=model[i];
                                }
                            }
                            if((JSON!=null)&&(Weights!=null)){
                                trainModel=await tf.loadLayersModel(tf.io.browserFiles([JSON, Weights]));
                            }else{
                                trainModel=null;
                                alert('Not model can load!');
                            }
                        }
                        loadModel();
                    ">Load Model!</button><br>
                    Config:
                    <textarea cols="30" rows="3" onchange="
                        try{
                            trainConfig=JSON.parse(this.value);
                        }catch{}
                    ">{"episodes":2000,"epsilon":1,"epsilon_min":0,"epsilon_stop_episode":1000}</textarea>
                    <script>
                        trainConfig=JSON.parse(this.value);
                    </script>
                </td>
            </tr>
            <tr>
                <td>
                    <div><img src onerror="Tetris_list.push(new Tetris(this.parentElement,20));Tetris_list[Tetris_list.length-1].print=true;" style="display:none"></div>
                </td>
            </tr>
            <tr>
                <td>
                    模型測試<br>
                    Model:<input type="file" id="upload-model" multiple="multiple"/>
                    <script>
                        var autoPlayAI=new autoPlay(Tetris_list[1]);
                    </script>
                    <button onclick="
                        let model=document.getElementById('upload-model').files;
                        let JSON;
                        let Weights;
                        for(let i=0;i<model.length;i++){
                            if(model[i].name.includes('json')){
                                JSON=model[i];
                            }else if(model[i].name.includes('bin')){
                                Weights=model[i];
                            }
                        }
                        if((JSON!=null)&&(Weights!=null)){
                            autoPlayAI.loadModel(JSON,Weights);
                        }else{
                            alert('Not model can load!');
                        }
                    ">Load Model!</button><br>
                    Model URL:<input id="model-url" value="model/model.json">
                    <button onclick="
                        let url=document.getElementById('model-url').value;
                        if((url!='')&&(url.includes('.json'))){
                            autoPlayAI.loadModelUrl(url);
                        }else{
                            alert('Not model can load!');
                        }
                    ">Load Model!</button><br>
                    <button onclick='
                        Tetris_list[1].doPrint=true;
                        Tetris_list[1].print=true;
                        Tetris_list[1].player=true;
                        Tetris_list[1].speed=20;
                        async function startAutoPlay(){
                                Tetris_list[1].reset();
                                Tetris_list[1].autoPlay(autoPlayAI);
                        }
                        if(autoPlayAI.model!=null){
                            startAutoPlay();
                        }else{
                            alert("Not model can run!");
                        }
                    '>Play</button>
                    <script>
                    </script>
                </td>
            </tr>
            <tr>
                <td>
                    <div><img src onerror="Tetris_list.push(new Tetris(this.parentElement,20));Tetris_list[Tetris_list.length-1].print=true;" style="display:none"></div>
                </td>
            </tr>
            <tr>
                <td>
                    玩
                    <button onclick='
                        Tetris_list[2].doPrint=true;
                        Tetris_list[2].print=true;
                        Tetris_list[2].player=true;
                        Tetris_list[2].start();
                    '>Play</button>
                    <script>
                        document.addEventListener('keydown',(e)=>{
                        	if(e.code==='ArrowUp'){
                        		
                        	}else if(e.code==='ArrowDown'){
                        		Tetris_list[2].doDrop();
                        	}else if(e.code==='ArrowRight'){
                        		Tetris_list[2].shapeRightMov();
                        	}else if(e.code==='ArrowLeft'){
                        		Tetris_list[2].shapeLeftMov();
                        	}else if(e.code==='KeyZ'){
                        		Tetris_list[2].shapeLeftRot();
                        	}else if(e.code==='KeyX'){
                        		Tetris_list[2].shapeRightRot();
                        	}else if(e.code==='Space'){
                                Tetris_list[2].doPrint=true;
                                Tetris_list[2].print=true;
                            Tetris_list[2].player=true;
                        		Tetris_list[2].start();
                        	}
                        });
                    </script>
                </td>
            </tr>
            <tr>
                <td><div><img src onerror="Tetris_list.push(new Tetris(this.parentElement,20));" style="display:none"></div></td>
            </tr>
        </table>
    </body>
</html>
